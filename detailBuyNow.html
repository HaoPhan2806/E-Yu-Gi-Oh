<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Detail Buy Now</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/detailBuyNow.css">
    <link rel="stylesheet" href="/fontawesome-free-5.15.4-web/css/all.min.css">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        function getShoppingcart() {
            if (localStorage.getItem("shoppingcart") == null || localStorage.getItem("shoppingcart") == undefined || localStorage.getItem("shoppingcart") == "[]") {
                $('#content').html("Products in the cart are currently not available!");
                $('#buynow').css("display", "none");
                TongTien();
            }
            else {
                $.post("/getDetailBuyNow", {
                    arrProductId: localStorage.getItem("shoppingcart").replace('[', '(').replace(']', ')')
                }, function (data, status) {
                    $('#content').html(data);
                    $('#buynow').css("display", "block");
                    TongTien();
                });
            }

        }

        function logout() {
            localStorage.removeItem("user")
            window.location.href = "/login";
        }

        function profile() {
            window.location.href = "/profile";
        }

        function buyProduct() {
            var arrSP = [];
            tongtien = 0
            $(".product").toArray().forEach(item => {
                arrSP.push({
                    MaSP: $(item).attr("productid"),
                    SoLuong: $(item).find(".soluong").val(),
                    GiaBan: $(item).attr("price"),
                })
                tongtien += $(item).attr("price") * $(item).find(".soluong").val();
            });
            $.post("/buyProducts", {
                MaKH: JSON.parse(localStorage.getItem("user"))[0].ID,
                arrSP: arrSP
            }, function (data, status) {
                alert("Thanh toán thành công.");
                localStorage.removeItem("shoppingcart")
                window.location.href = "/shoppingcart";
            });

        }
        function TongTien(){
            var arrSP = [];
            tongtien = 0
            $(".product").toArray().forEach(item => {
                arrSP.push({
                    MaSP: $(item).attr("productid"),
                    SoLuong: $(item).find(".soluong").val(),
                    GiaBan: $(item).attr("price"),
                })
                tongtien += $(item).attr("price") * $(item).find(".soluong").val();
            });
            $('#thanhtoan').html(tongtien);
        }


        $(document).ready(function () {
            getShoppingcart();

            var user = localStorage.getItem("user");
            if (user === null || user === undefined) {
                $("#imgadd").attr("src", "/img/iconPeople.jpg");
                $("#signin").css("display", "block");
                $("#signout").css("display", "none");
                $("#profile").css("display", "none");
            }
            else {
                var objUser = JSON.parse(user)
                $.get("http://localhost:6969/EditPersonal/" + objUser[0].ID, function (data, status) {
                    $("#imgadd").attr("src", "/img/" + data.AnhDaiDien);
                });
                $("#signout").css("display", "block");
                $("#profile").css("display", "block");
                $("#signin").css("display", "none");
            }
            
            $.get("http://localhost:6969/getProfile/" + objUser[0].ID, function (data, status) {
                $("#hotenND").html(data.HoTenND);
                $("#email").html(data.Email);
                $("#sdt").html(data.SDT);
                $("#address").html(data.Diachi);
                $("#city").html(data.ThanhPho);
            });
        });

    </script>
</head>

<body>
    <header class="header">
        <nav class="nav">
            <a href="/index"><img src="/img/konami-logo.png"></a>
            <div class="nav-links">
                <ul>
                    <li><a href="/index">HOME</a></li>
                    <li><a href="/product">PRODUCT</a></li>
                    <li><a href="/blog">BLOG</a></li>
                    <li><a href="/contact">CONTACT</a></li>
                    <li class="dropdown">
                        <img id="imgadd" onclick="logout()">
                        <ul class="submenu">
                            <li id="signin"><span onclick="logout()" class="dropdownmenu">SignIn</span></li>
                            <li id="profile" style="display: none; text-align: center;"><span onclick="profile()"
                                    class="dropdownmenu">ProFile</span>
                            </li>
                            <li id="signout" style="display: none; text-align: center;"><span
                                    onclick="logout()" class="dropdownmenu">SignOut</span>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <section class="u-section-1">
        <div class="u-sheet-1">
            <div class="u-layout-wrap-1">
                <div class="u-layout-cell-1">
                    <div><input id="buynow" type="button" value="BUY NOW" onclick="buyProduct()"></div>
                    
                    <div class="Tongtien">Total: <span id="thanhtoan">0 </span> $</div>
                    <div id="content"></div>
                    <div class="thongtin">Thông tin khách hàng</div>
                    <div class="card-body">

                        <div class="rowcustomer">
                            <div class="col-md-3">
                                <h5 class="h5">Full Name:</h5>
                            </div>
                            <div class="col-md-9 text-secondary">
                                <div class="pn"><b id="hotenND"></b></div>
                            </div>
                        </div>
                        <hr>
                        <div class="rowcustomer">
                            <div class="col-md-3">
                                <h5 class="h5">Email:</h5>
                            </div>
                            <div class="col-md-9 text-secondary">
                                <div class="pn" id="email"></div>
                            </div>
                        </div>
                        <hr>
                        <div class="rowcustomer">
                            <div class="col-md-3">
                                <h5 class="h5">Phone:</h5>
                            </div>
                            <div class="col-md-9 text-secondary">
                                <div class="pn" id="sdt"></div>
                            </div>
                        </div>
                        <hr>
                        <div class="rowcustomer">
                            <div class="col-md-3">
                                <h5 class="h5">Address:</h5>
                            </div>
                            <div class="col-md-9 text-secondary">
                                <div class="pn" id="address"></div>
                            </div>
                        </div>
                        <hr>
                        <div class="rowcustomer">
                            <div class="col-md-3">
                                <h5 class="h5">City:</h5>
                            </div>
                            <div class="col-md-9 text-secondary">
                                <div class="pn" id="city"></div>
                            </div>
                        </div>
                        <hr>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="row">
            <div class="col">
                <img class="img" src="/img/konami-logo.png">
                <p>Konami Shop - sự lựa chọn uy tín nhất cho mọi duelist. Mở bán trên toàn quốc gia và vũng lãnh thổ
                    trong các ngày trong tuần từ 8h-20h. Hãy đặt mua những lá bài mà bạn cảm thấy ưa thích nhất và sở
                    hữu nó để trở thành một duelist số 1.</p>
            </div>
            <div class="col">
                <h3>Thông Tin</h3>
                <p><i class="fas fa-map-marker-alt"></i> Số 69/68 Đặng Thùy Trâm P13 Q.Bình Thạnh TPHCM.</p>
                <p><i class="far fa-id-card"></i> (+84) 917508594</p>
                <p class="email-id">hao.207pm27398@gmail.com.vn</p>
            </div>
            <div class="col">
                <h3>Liên Hệ</h3>
                <div class="social-icons">
                    <i class="fab fa-facebook"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-youtube"></i>
                    <i class="fab fa-twitter"></i>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>